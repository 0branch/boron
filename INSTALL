# Boron Install Makefile for Linux & Mac
# This assumes the shared library was configured and built.

OS := $(shell uname)
DESTDIR ?= /usr/local

VER=2.0.5
BDIR=.
BIN_DIR=$(DESTDIR)/bin
LIB_DIR=$(DESTDIR)/lib
INC_DIR=$(DESTDIR)/include/boron
MAN_DIR=$(DESTDIR)/share/man/man1
VIM_DIR=$(DESTDIR)/share/vim/vimfiles/syntax

ifneq ($(OS), Darwin)
ifeq ($(shell file -b /usr/lib64), directory)
LIB_DIR=$(DESTDIR)/lib64
endif
endif

.PHONY: install uninstall install-dev uninstall-dev

install:
	mkdir -p $(BIN_DIR) $(LIB_DIR) $(MAN_DIR)
ifeq ($(OS), Darwin)
	install_name_tool -id $(LIB_DIR)/libboron.dylib $(BDIR)/libboron.dylib
	install_name_tool -change libboron.dylib $(LIB_DIR)/libboron.dylib $(BDIR)/boron
endif
	install -s -m 755 $(BDIR)/boron $(BIN_DIR)
ifeq ($(OS), Darwin)
	install -m 644 $(BDIR)/libboron.dylib $(LIB_DIR)
else
	install -m 755 -s $(BDIR)/libboron.so.$(VER) $(LIB_DIR)
	ln -s libboron.so.$(VER) $(LIB_DIR)/libboron.so.2
endif
	gzip -c -n doc/boron.troff > doc/boron.1.gz
	install -m 644 doc/boron.1.gz $(MAN_DIR)/boron.1

uninstall:
	rm -f $(BIN_DIR)/boron $(MAN_DIR)/boron.1
ifeq ($(OS), Darwin)
	rm -f $(LIB_DIR)/libboron.dylib
else
	rm -f $(LIB_DIR)/libboron.so.2 $(LIB_DIR)/libboron.so.$(VER)
endif

install-dev:
	mkdir -p $(INC_DIR) $(LIB_DIR) $(VIM_DIR)
	sed -e 's~"urlan.h"~<boron/urlan.h>~' $(BDIR)/include/boron.h >temp.h
	install -m 644 temp.h $(INC_DIR)/boron.h
	install -m 644 $(BDIR)/include/urlan.h        $(INC_DIR)
	install -m 644 $(BDIR)/include/urlan_atoms.h  $(INC_DIR)
#	install -m 755 scripts/copr.b $(BIN_DIR)/copr
ifneq ($(OS), Darwin)
	install -m 644 doc/boron.vim $(VIM_DIR)
	ln -s libboron.so.$(VER) $(LIB_DIR)/libboron.so
endif

uninstall-dev:
ifneq ($(OS), Darwin)
	rm -f $(LIB_DIR)/libboron.so $(VIM_DIR)/boron.vim
endif
#	rm -f $(BIN_DIR)/copr
	rm -f $(INC_DIR)/boron.h $(INC_DIR)/urlan.h $(INC_DIR)/urlan_atoms.h
	rmdir $(INC_DIR)
